name: Deploy to Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Deploy to Production
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.USERNAME }}@${{ secrets.HOST }} << 'EOF'
          set -e

          echo "ðŸ‘‰ ÐŸÐµÑ€ÐµÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ÑÑ Ð² Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°"
          cd /home/projects/gpt-api

          echo "ðŸ‘‰ ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð¸Ð· Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ñ"
          git pull origin main

          echo "ðŸ‘‰ ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð² Ñ„Ð°Ð¹Ð»Ð°Ñ…"
          CHANGED_FILES=$(git diff HEAD@{1} HEAD --name-only)

          echo "Ð˜Ð·Ð¼ÐµÐ½Ñ‘Ð½Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹:"
          echo "$CHANGED_FILES"

          if echo "$CHANGED_FILES" | grep -q -E "composer.lock|composer.json"; then
            echo "ðŸ“¦ Ð•ÑÑ‚ÑŒ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð² Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÑÑ… â€” Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ composer install"
            docker compose exec -T laravel composer install --no-interaction --prefer-dist --no-dev --optimize-autoloader
          else
            echo "ðŸ“¦ ÐÐµÑ‚ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹ Ð² Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÑÑ…"
          fi

          if echo "$CHANGED_FILES" | grep -q "database/migrations"; then
            echo "ðŸ—„ï¸ Ð•ÑÑ‚ÑŒ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð² Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸ÑÑ… â€” Ð·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ php artisan migrate"
            docker compose exec -T laravel php artisan migrate --force
          else
            echo "ðŸ—„ï¸ ÐÐµÑ‚ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹ Ð² Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸ÑÑ…"
          fi

          echo "âœ… Ð”ÐµÐ¿Ð»Ð¾Ð¹ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð·Ð°Ð²ÐµÑ€ÑˆÑ‘Ð½"
        EOF

